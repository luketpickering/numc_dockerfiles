# syntax=docker/dockerfile:1
FROM picker24/root_v6_26_10:alma9 as hlpsyche_build
WORKDIR /

#ND280ARCH=aarch64
#ND280ARCH=x86_64
ARG ND280ARCH

RUN ln -s $(which python3) /usr/local/bin/python

ENV HIGHLAND2MASTERVER=2.84.3

ENV ND280_ROOT=/opt/nd280

RUN mkdir -p ${ND280_ROOT}
WORKDIR ${ND280_ROOT}

RUN mkdir -p ~/.ssh/
RUN ssh-keyscan git.t2k.org > ~/.ssh/known_hosts

RUN --mount=type=ssh git clone git@git.t2k.org:nd280/pilot/nd280SoftwarePilot.git
WORKDIR ${ND280_ROOT}/nd280SoftwarePilot
RUN git checkout stable && ./configure.sh

ENV ND280_GIT="git@git.t2k.org:nd280/"
ENV ND280_DOWNLOADS="http://nd280.lancs.ac.uk/downloads"

ENV GIT_SSH_COMMAND="ssh -o ControlMaster=auto -o ControlPath=/tmp/%C -o ControlPersist=3600 "

ENV ND280PILOT_ROOT=${ND280_ROOT}
ENV PATH=${ND280PILOT_ROOT}/nd280SoftwarePilot/scripts:${PATH}
ENV CMAKE_PREFIX_PATH=${ND280PILOT_ROOT}:${CMAKE_PREFIX_PATH}
ENV ND280_SYSTEM=Linux-AlmaLinux_9.1-gcc_11-${ND280ARCH}

WORKDIR ${ND280_ROOT}

RUN --mount=type=ssh git clone git@git.t2k.org:nd280/highland2Software/highland2SoftwarePilot.git
WORKDIR ${ND280_ROOT}/highland2SoftwarePilot
RUN git checkout master

ENV PATH=${ND280_ROOT}/highland2SoftwarePilot/scripts:${PATH}
ENV ROOTROOT=${ROOTSYS}
ENV ROOT_VERSION_MAJOR=6
ENV ND280PROD=prod6T

RUN --mount=type=ssh highland-install -c -p ${ND280PROD} ${HIGHLAND2MASTERVER}

WORKDIR ${ND280_ROOT}/nd280SoftwarePolicy_master
RUN --mount=type=ssh git checkout feature/cxx_standard_set

WORKDIR ${ND280_ROOT}

RUN highland_set_use_psycheROOT -r psycheROOT
RUN --mount=type=ssh highland-install -p ${ND280PROD} -DND280_PROJECT_CXX_STANDARD=17 -j 8 ${HIGHLAND2MASTERVER}

ENV ND280SOFTWAREPOLICY_ROOT=${ND280_ROOT}/nd280SoftwarePolicy_master

FROM picker24/root_v6_26_10:alma9 as tidy_layer
ARG ND280ARCH

ENV ND280_SYSTEM=Linux-AlmaLinux_9.1-gcc_11-${ND280ARCH}

COPY --from=hlpsyche_build /opt/nd280 /opt/nd280_allsrc

ENV OAANALYSISREADERVER=2.27.2
ENV ND280PROD=prod6T

RUN bash -c 'set -x; for f in /opt/nd280_allsrc/*/; do ODIR=$(echo $f | sed "s/_allsrc//g"); mkdir -p ${ODIR}/${ND280_SYSTEM}/lib; cp -r ${f}/{parameters,data,inc} ${ODIR}/; cp -r ${f}/${ND280_SYSTEM}/lib ${ODIR}/${ND280_SYSTEM}; done'
RUN mv /opt/nd280_allsrc/oaAnalysisReader_${OAANALYSISREADERVER}/src/${ND280PROD}/oaAnalysisReaderProjectDict_rdict.pcm \
        /opt/nd280/oaAnalysisReader_${OAANALYSISREADERVER}/${ND280_SYSTEM}/lib/

FROM picker24/root_v6_26_10:alma9

ARG ND280ARCH

COPY --from=tidy_layer /opt/nd280 /opt/nd280

ENV ND280_ROOT=/opt/nd280 \
    ND280_SYSTEM=Linux-AlmaLinux_9.1-gcc_11-${ND280ARCH} \
    ND280PROD=prod6T \
    PSYCHEMASTERVER=3.81.1 \
    PSYCHESYSTEMATICSVER=3.60 \
    PSYCHEND280UTILSVER=3.69.1 \
    PSYCHEEVENTMODELVER=3.46 \
    PSYCHEUTILSVER=3.35 \
    PSYCHESTEERINGVER=3.45 \
    PSYCHEIOVER=3.39 \
    PSYCHESELECTIONSVER=3.58 \
    PSYCHECOREVER=3.50

ENV PSYCHE_PACKAGES=PSYCHEMASTER:PSYCHESYSTEMATICS:PSYCHEND280UTILS:PSYCHEEVENTMODEL:PSYCHEUTILS:PSYCHESTEERING:PSYCHEIO:PSYCHESELECTIONS:PSYCHECORE \
    PSYCHEMASTERROOT=${ND280_ROOT}/psycheMaster_${PSYCHEMASTERVER} \
    PSYCHEMASTERCONFIG=${ND280_SYSTEM} \
    PSYCHESYSTEMATICSROOT=${ND280_ROOT}/psycheSystematics_${PSYCHESYSTEMATICSVER} \
    PSYCHESYSTEMATICSCONFIG=${ND280_SYSTEM} \
    PSYCHEND280UTILSROOT=${ND280_ROOT}/psycheND280Utils_${PSYCHEND280UTILSVER} \
    PSYCHEND280UTILSCONFIG=${ND280_SYSTEM} \
    PSYCHEEVENTMODELROOT=${ND280_ROOT}/psycheEventModel_${PSYCHEEVENTMODELVER} \
    PSYCHEEVENTMODELCONFIG=${ND280_SYSTEM} \
    PSYCHEUTILSROOT=${ND280_ROOT}/psycheUtils_${PSYCHEUTILSVER} \
    PSYCHEUTILSCONFIG=${ND280_SYSTEM} \
    PSYCHESTEERINGROOT=${ND280_ROOT}/psycheSteering_${PSYCHESTEERINGVER} \
    PSYCHESTEERINGCONFIG=${ND280_SYSTEM} \
    PSYCHEIOROOT=${ND280_ROOT}/psycheIO_${PSYCHEIOVER} \
    PSYCHEIOCONFIG=${ND280_SYSTEM} \
    PSYCHESELECTIONSROOT=${ND280_ROOT}/psycheSelections_${PSYCHESELECTIONSVER} \
    PSYCHESELECTIONSCONFIG=${ND280_SYSTEM} \
    PSYCHECOREROOT=${ND280_ROOT}/psycheCore_${PSYCHECOREVER} \
    PSYCHECORECONFIG=${ND280_SYSTEM}

ENV LD_LIBRARY_PATH=${PSYCHEMASTERROOT}/${PSYCHEMASTERCONFIG}/lib:${PSYCHESYSTEMATICSROOT}/${PSYCHESYSTEMATICSCONFIG}/lib:${PSYCHEND280UTILSROOT}/${PSYCHEND280UTILSCONFIG}/lib:${PSYCHEEVENTMODELROOT}/${PSYCHEEVENTMODELCONFIG}/lib:${PSYCHEUTILSROOT}/${PSYCHEUTILSCONFIG}/lib:${PSYCHESTEERINGROOT}/${PSYCHESTEERINGCONFIG}/lib:${PSYCHEIOROOT}/${PSYCHEIOCONFIG}/lib:${PSYCHESELECTIONSROOT}/${PSYCHESELECTIONSCONFIG}/lib:${PSYCHECOREROOT}/${PSYCHECORECONFIG}/lib:${LD_LIBRARY_PATH}

ENV HIGHLAND2MASTERVER=2.84.3 \
    HIGHLANDCOREVER=2.45 \
    HIGHLANDCORRECTIONSVER=2.31 \
    HIGHLANDEVENTMODELVER=2.40.1 \
    HIGHLANDIOVER=2.50 \
    HIGHLANDSYSTEMATICSVER=2.13 \
    HIGHLANDTOOLSVER=2.31 \
    HIGHLANDUTILSVER=2.45 \
    OAANALYSISREADERVER=2.27.2

ENV HIGHLAND2_PACKAGES=HIGHLAND2MASTER:HIGHLANDCORE:HIGHLANDCORRECTIONS:HIGHLANDEVENTMODEL:HIGHLANDIO:HIGHLANDSYSTEMATICS:HIGHLANDTOOLS:HIGHLANDUTILS:$HIGHLANDVALIDATION:OAANALYSISREADER \
    HIGHLAND2MASTERROOT=${ND280_ROOT}/highland2Master_${HIGHLAND2MASTERVER} \
    HIGHLAND2MASTERCONFIG=${ND280_SYSTEM} \
    HIGHLANDCOREROOT=${ND280_ROOT}/highlandCore_${HIGHLANDCOREVER} \
    HIGHLANDCORECONFIG=${ND280_SYSTEM} \
    HIGHLANDCORRECTIONSROOT=${ND280_ROOT}/highlandCorrections_${HIGHLANDCORRECTIONSVER} \
    HIGHLANDCORRECTIONSCONFIG=${ND280_SYSTEM} \
    HIGHLANDEVENTMODELROOT=${ND280_ROOT}/highlandEventModel_${HIGHLANDEVENTMODELVER} \
    HIGHLANDEVENTMODELCONFIG=${ND280_SYSTEM} \
    HIGHLANDIOROOT=${ND280_ROOT}/highlandIO_${HIGHLANDIOVER} \
    HIGHLANDIOCONFIG=${ND280_SYSTEM} \
    HIGHLANDSYSTEMATICSROOT=${ND280_ROOT}/highlandSystematics_${HIGHLANDSYSTEMATICSVER} \
    HIGHLANDSYSTEMATICSCONFIG=${ND280_SYSTEM} \
    HIGHLANDTOOLSROOT=${ND280_ROOT}/highlandTools_${HIGHLANDTOOLSVER} \
    HIGHLANDTOOLSCONFIG=${ND280_SYSTEM} \
    HIGHLANDUTILSROOT=${ND280_ROOT}/highlandUtils_${HIGHLANDUTILSVER} \
    HIGHLANDUTILSCONFIG=${ND280_SYSTEM} \
    OAANALYSISREADERROOT=${ND280_ROOT}/oaAnalysisReader_${OAANALYSISREADERVER} \
    OAANALYSISREADERCONFIG=${ND280_SYSTEM}

ENV LD_LIBRARY_PATH=${HIGHLAND2MASTERROOT}/${HIGHLAND2MASTERCONFIG}/lib:${HIGHLANDCOREROOT}/${HIGHLANDCORECONFIG}/lib:${HIGHLANDCORRECTIONSROOT}/${HIGHLANDCORRECTIONSCONFIG}/lib:${HIGHLANDEVENTMODELROOT}/${HIGHLANDEVENTMODELCONFIG}/lib:${HIGHLANDIOROOT}/${HIGHLANDIOCONFIG}/lib:${HIGHLANDSYSTEMATICSROOT}/${HIGHLANDSYSTEMATICSCONFIG}/lib:${HIGHLANDTOOLSROOT}/${HIGHLANDTOOLSCONFIG}/lib:${HIGHLANDUTILSROOT}/${HIGHLANDUTILSCONFIG}/lib:${OAANALYSISREADERROOT}/${OAANALYSISREADERCONFIG}/lib:${LD_LIBRARY_PATH}

ENV ROOT_INCLUDE_PATH=${OAANALYSISREADERROOT}/inc/${ND280PROD}:${ROOT_INCLUDE_PATH}

ENV ANTINUECCANALYSISVER=2.18 \
    ANTINUMUCCANALYSISVER=2.7 \
    ANTINUMUCCMULTIPIANALYSISVER=2.12 \
    BASEANALYSISVER=2.34 \
    BASEP0DANALYSISVER=2.7 \
    BASETRACKERANALYSISVER=2.26 \
    GAMMAANALYSISVER=2.19 \
    NUECCANALYSISVER=2.30 \
    NUMUBKGINANTINUMODEANALYSISVER=2.12 \
    NUMUCC4PIMULTIPIANALYSISVER=2.0 \
    NUMUCCANALYSISVER=2.22 \
    NUMUCCMULTIPIANALYSISVER=2.32 \
    NUMUCCZEROPIANALYSISVER=2.13 \
    P0DNUMUCCANALYSISVER=2.17 \
    TUTORIALANALYSISVER=2.23

ENV HIGHLAND2_ANALYSES=ANTINUMUCCANALYSIS:ANTINUMUCCANALYSIS:ANTINUMUCCMULTIPIANALYSIS:BASEANALYSIS:BASEP0DANALYSIS:BASETRACKERANALYSIS:GAMMAANALYSIS:NUECCANALYSIS:NUMUBKGINANTINUMODEANALYSIS:NUMUCC4PIMULTIPIANALYSIS:NUMUCCANALYSIS:NUMUCCMULTIPIANALYSIS:NUMUCCZEROPIANALYSIS:P0DNUMUCCANALYSIS:TUTORIALANALYSIS \
    ANTINUECCANALYSISROOT=${ND280_ROOT}/antiNueCCAnalysis_${ANTINUECCANALYSISVER} \
    ANTINUECCANALYSISCONFIG=${ND280_SYSTEM} \
    ANTINUMUCCANALYSISROOT=${ND280_ROOT}/antiNumuCCAnalysis_${ANTINUMUCCANALYSISVER} \
    ANTINUMUCCANALYSISCONFIG=${ND280_SYSTEM} \
    ANTINUMUCCMULTIPIANALYSISROOT=${ND280_ROOT}/antiNumuCCMultiPiAnalysis_${ANTINUMUCCMULTIPIANALYSISVER} \
    ANTINUMUCCMULTIPIANALYSISCONFIG=${ND280_SYSTEM} \
    BASEANALYSISROOT=${ND280_ROOT}/baseAnalysis_${BASEANALYSISVER} \
    BASEANALYSISCONFIG=${ND280_SYSTEM} \
    BASEP0DANALYSISROOT=${ND280_ROOT}/baseP0DAnalysis_${BASEP0DANALYSISVER} \
    BASEP0DANALYSISCONFIG=${ND280_SYSTEM} \
    BASETRACKERANALYSISROOT=${ND280_ROOT}/baseTrackerAnalysis_${BASETRACKERANALYSISVER} \
    BASETRACKERANALYSISCONFIG=${ND280_SYSTEM} \
    GAMMAANALYSISROOT=${ND280_ROOT}/gammaAnalysis_${GAMMAANALYSISVER} \
    GAMMAANALYSISCONFIG=${ND280_SYSTEM} \
    NUECCANALYSISROOT=${ND280_ROOT}/nueCCAnalysis_${NUECCANALYSISVER} \
    NUECCANALYSISCONFIG=${ND280_SYSTEM} \
    NUMUBKGINANTINUMODEANALYSISROOT=${ND280_ROOT}/numuBkgInAntiNuModeAnalysis_${NUMUBKGINANTINUMODEANALYSISVER} \
    NUMUBKGINANTINUMODEANALYSISCONFIG=${ND280_SYSTEM} \
    NUMUCC4PIMULTIPIANALYSISROOT=${ND280_ROOT}/numuCC4piMultiPiAnalysis_${NUMUCC4PIMULTIPIANALYSISVER} \
    NUMUCC4PIMULTIPIANALYSISCONFIG=${ND280_SYSTEM} \
    NUMUCCANALYSISROOT=${ND280_ROOT}/numuCCAnalysis_${NUMUCCANALYSISVER} \
    NUMUCCANALYSISCONFIG=${ND280_SYSTEM} \
    NUMUCCMULTIPIANALYSISROOT=${ND280_ROOT}/numuCCMultiPiAnalysis_${NUMUCCMULTIPIANALYSISVER} \
    NUMUCCMULTIPIANALYSISCONFIG=${ND280_SYSTEM} \
    NUMUCCZEROPIANALYSISROOT=${ND280_ROOT}/numuCCZeroPiAnalysis_${NUMUCCZEROPIANALYSISVER} \
    NUMUCCZEROPIANALYSISCONFIG=${ND280_SYSTEM} \
    P0DNUMUCCANALYSISROOT=${ND280_ROOT}/p0dNumuCCAnalysis_${P0DNUMUCCANALYSISVER} \
    P0DNUMUCCANALYSISCONFIG=${ND280_SYSTEM} \
    TUTORIALANALYSISROOT=${ND280_ROOT}/tutorialAnalysis_${TUTORIALANALYSISVER} \
    TUTORIALANALYSISCONFIG=${ND280_SYSTEM}

ENV LD_LIBRARY_PATH=${ANTINUECCANALYSISROOT}/${ANTINUECCANALYSISCONFIG}/lib:${ANTINUMUCCANALYSISROOT}/${ANTINUMUCCANALYSISCONFIG}/lib:${ANTINUMUCCMULTIPIANALYSISROOT}/${ANTINUMUCCMULTIPIANALYSISCONFIG}/lib:${BASEANALYSISROOT}/${BASEANALYSISCONFIG}/lib:${BASEP0DANALYSISROOT}/${BASEP0DANALYSISCONFIG}/lib:${BASETRACKERANALYSISROOT}/${BASETRACKERANALYSISCONFIG}/lib:${GAMMAANALYSISROOT}/${GAMMAANALYSISCONFIG}/lib:${NUECCANALYSISROOT}/${NUECCANALYSISCONFIG}/lib:${NUMUBKGINANTINUMODEANALYSISROOT}/${NUMUBKGINANTINUMODEANALYSISCONFIG}/lib:${NUMUCC4PIMULTIPIANALYSISROOT}/${NUMUCC4PIMULTIPIANALYSISCONFIG}/lib:${NUMUCCANALYSISROOT}/${NUMUCCANALYSISCONFIG}/lib:${NUMUCCMULTIPIANALYSISROOT}/${NUMUCCMULTIPIANALYSISCONFIG}/lib:${NUMUCCZEROPIANALYSISROOT}/${NUMUCCZEROPIANALYSISCONFIG}/lib:${P0DNUMUCCANALYSISROOT}/${P0DNUMUCCANALYSISCONFIG}/lib:${TUTORIALANALYSISROOT}/${TUTORIALANALYSISCONFIG}/lib:${LD_LIBRARY_PATH}
