FROM picker24/root_v6_24_06:centos_7 AS psyche_build
WORKDIR /

ARG ND280ARCH

ENV PSYCHEMASTERVER=3.73
ENV OAANALYSISREADER_VERSION=2.25

ENV ND280_ROOT=/opt/nd280

RUN mkdir -p ${ND280_ROOT}
WORKDIR ${ND280_ROOT}

RUN mkdir -p ~/.ssh/
RUN ssh-keyscan git.t2k.org > ~/.ssh/known_hosts

RUN --mount=type=ssh git clone git@git.t2k.org:nd280/pilot/nd280SoftwarePilot.git
WORKDIR ${ND280_ROOT}/nd280SoftwarePilot
RUN git checkout stable && ./configure.sh

ENV ND280_GIT="git@git.t2k.org:nd280/"
ENV ND280_DOWNLOADS="http://nd280.lancs.ac.uk/downloads"

ENV ND280PILOT_ROOT=${ND280_ROOT}
ENV PATH=${ND280PILOT_ROOT}/nd280SoftwarePilot/scripts:${PATH}
ENV CMAKE_PREFIX_PATH=${ND280PILOT_ROOT}:${CMAKE_PREFIX_PATH}
ENV ND280_SYSTEM=Linux-CentOS_7-gcc_4.8-${ND280ARCH}

WORKDIR ${ND280_ROOT}

RUN --mount=type=ssh git clone git@git.t2k.org:nd280/highland2Software/highland2SoftwarePilot.git
WORKDIR ${ND280_ROOT}/highland2SoftwarePilot
RUN git checkout stable

ENV PATH=${ND280_ROOT}/highland2SoftwarePilot/scripts:${PATH}
ENV ROOTROOT=${ROOTSYS}
ENV ROOT_VERSION_MAJOR=6
ENV ND280PROD=prod6T

RUN --mount=type=ssh highland-install -c -p ${ND280PROD} -d ${PSYCHEMASTERVER}
RUN highland_set_use_psycheROOT -r psycheROOT

ENV ND280SOFTWAREPOLICY_ROOT=${ND280_ROOT}/nd280SoftwarePolicy_master
WORKDIR ${ND280SOFTWAREPOLICY_ROOT}
RUN git checkout master
WORKDIR ${ND280_ROOT}/highland2SoftwarePilot
RUN highland-install -p ${ND280PROD} -d ${PSYCHEMASTERVER}

WORKDIR ${ND280_ROOT}

ENV OAANALYSISREADERROOT=${ND280_ROOT}/oaAnalysisReader_${OAANALYSISREADER_VERSION}
ENV OAANALYSISREADERCONFIG=${ND280_SYSTEM}

RUN --mount=type=ssh git clone git@git.t2k.org:nd280/highland2Software/highland2/oaAnalysisReader.git oaAnalysisReader_${OAANALYSISREADER_VERSION}
WORKDIR ${OAANALYSISREADERROOT}
RUN git checkout origin/${OAANALYSISREADER_VERSION}.x
RUN echo "ND280_USE(psycheROOT)" > ${OAANALYSISREADERROOT}/cmake/oaAnalysisReaderND280_USE.cmake

RUN mkdir -p ${OAANALYSISREADERROOT}/${OAANALYSISREADERCONFIG}
WORKDIR ${OAANALYSISREADERROOT}/${OAANALYSISREADERCONFIG}
RUN cmake ../cmake -Dnd280SoftwarePolicy_DIR=${ND280_ROOT}/nd280SoftwarePolicy/cmake/
RUN make

FROM picker24/root_v6_24_06:centos_7

ARG ND280ARCH

ENV PSYCHEMASTERVER=3.73

ENV ND280_ROOT=/opt/nd280
ENV ND280_SYSTEM=Linux-CentOS_7-gcc_4.8-${ND280ARCH}
ENV ND280PROD=prod6T

ENV PSYCHEMASTERROOT=${ND280_ROOT}/psycheMaster_3.73
ENV PSYCHEMASTERCONFIG=${ND280_SYSTEM}

ENV PSYCHESYSTEMATICSROOT=${ND280_ROOT}/psycheSystematics_3.56
ENV PSYCHESYSTEMATICSCONFIG=${ND280_SYSTEM}

ENV PSYCHEND280UTILSROOT=${ND280_ROOT}/psycheND280Utils_3.65
ENV PSYCHEND280UTILSCONFIG=${ND280_SYSTEM}

ENV PSYCHEEVENTMODELROOT=${ND280_ROOT}/psycheEventModel_3.43 
ENV PSYCHEEVENTMODELCONFIG=${ND280_SYSTEM}

ENV PSYCHEUTILSROOT=${ND280_ROOT}/psycheUtils_3.34
ENV PSYCHEUTILSCONFIG=${ND280_SYSTEM}

ENV PSYCHESTEERINGROOT=${ND280_ROOT}/psycheSteering_3.42
ENV PSYCHESTEERINGCONFIG=${ND280_SYSTEM}

ENV PSYCHEIOROOT=${ND280_ROOT}/psycheIO_3.36
ENV PSYCHEIOCONFIG=${ND280_SYSTEM}

ENV PSYCHESELECTIONSROOT=${ND280_ROOT}/psycheSelections_3.52
ENV PSYCHESELECTIONSCONFIG=${ND280_SYSTEM}

ENV PSYCHECOREROOT=${ND280_ROOT}/psycheCore_3.45.1
ENV PSYCHECORECONFIG=${ND280_SYSTEM}

ENV PSYCHE_PACKAGES=PSYCHEMASTER:PSYCHESYSTEMATICS:ND280UTILS:PSYCHEEVENTMODEL:PSYCHEUTILS:PSYCHESTEERING:PSYCHEIO:PSYCHESELECTIONS:PSYCHECORE

RUN mkdir -p ${PSYCHEMASTERROOT}/${PSYCHEMASTERCONFIG}
COPY --from=psyche_build ${PSYCHEMASTERROOT}/${PSYCHEMASTERCONFIG}/lib ${PSYCHEMASTERROOT}/${PSYCHEMASTERCONFIG}/lib
ENV LD_LIBRARY_PATH=${PSYCHEMASTERROOT}/${PSYCHEMASTERCONFIG}/lib:${LD_LIBRARY_PATH}

RUN mkdir -p ${PSYCHESYSTEMATICSROOT}/${PSYCHESYSTEMATICSCONFIG}
COPY --from=psyche_build ${PSYCHESYSTEMATICSROOT}/inc ${PSYCHESYSTEMATICSROOT}/inc
COPY --from=psyche_build ${PSYCHESYSTEMATICSROOT}/parameters ${PSYCHESYSTEMATICSROOT}/parameters
COPY --from=psyche_build ${PSYCHESYSTEMATICSROOT}/data ${PSYCHESYSTEMATICSROOT}/data
COPY --from=psyche_build ${PSYCHESYSTEMATICSROOT}/${PSYCHESYSTEMATICSCONFIG}/lib ${PSYCHESYSTEMATICSROOT}/${PSYCHESYSTEMATICSCONFIG}/lib
ENV LD_LIBRARY_PATH=${PSYCHESYSTEMATICSROOT}/${PSYCHESYSTEMATICSCONFIG}/lib:${LD_LIBRARY_PATH}

RUN mkdir -p ${PSYCHEND280UTILSROOT}/${PSYCHEND280UTILSCONFIG}
COPY --from=psyche_build ${PSYCHEND280UTILSROOT}/inc ${PSYCHEND280UTILSROOT}/inc
COPY --from=psyche_build ${PSYCHEND280UTILSROOT}/parameters ${PSYCHEND280UTILSROOT}/parameters
COPY --from=psyche_build ${PSYCHEND280UTILSROOT}/data ${PSYCHEND280UTILSROOT}/data
COPY --from=psyche_build ${PSYCHEND280UTILSROOT}/${PSYCHEND280UTILSCONFIG}/lib ${PSYCHEND280UTILSROOT}/${PSYCHEND280UTILSCONFIG}/lib
ENV LD_LIBRARY_PATH=${PSYCHEND280UTILSROOT}/${PSYCHEND280UTILSCONFIG}/lib:${LD_LIBRARY_PATH}

RUN mkdir -p ${PSYCHEEVENTMODELROOT}/${PSYCHEEVENTMODELCONFIG}
COPY --from=psyche_build ${PSYCHEEVENTMODELROOT}/inc ${PSYCHEEVENTMODELROOT}/inc
COPY --from=psyche_build ${PSYCHEEVENTMODELROOT}/${PSYCHEEVENTMODELCONFIG}/lib ${PSYCHEEVENTMODELROOT}/${PSYCHEEVENTMODELCONFIG}/lib
ENV LD_LIBRARY_PATH=${PSYCHEEVENTMODELROOT}/${PSYCHEEVENTMODELCONFIG}/lib:${LD_LIBRARY_PATH}

RUN mkdir -p ${PSYCHEUTILSROOT}/${PSYCHEUTILSCONFIG}
COPY --from=psyche_build ${PSYCHEUTILSROOT}/inc ${PSYCHEUTILSROOT}/inc
COPY --from=psyche_build ${PSYCHEUTILSROOT}/parameters ${PSYCHEUTILSROOT}/parameters
COPY --from=psyche_build ${PSYCHEUTILSROOT}/data ${PSYCHEUTILSROOT}/data
COPY --from=psyche_build ${PSYCHEUTILSROOT}/${PSYCHEUTILSCONFIG}/lib ${PSYCHEUTILSROOT}/${PSYCHEUTILSCONFIG}/lib
ENV LD_LIBRARY_PATH=${PSYCHEUTILSROOT}/${PSYCHEUTILSCONFIG}/lib:${LD_LIBRARY_PATH}

RUN mkdir -p ${PSYCHESTEERINGROOT}/${PSYCHESTEERINGCONFIG}
COPY --from=psyche_build ${PSYCHESTEERINGROOT}/inc ${PSYCHESTEERINGROOT}/inc
COPY --from=psyche_build ${PSYCHESTEERINGROOT}/parameters ${PSYCHESTEERINGROOT}/parameters
COPY --from=psyche_build ${PSYCHESTEERINGROOT}/${PSYCHESTEERINGCONFIG}/lib ${PSYCHESTEERINGROOT}/${PSYCHESTEERINGCONFIG}/lib
ENV LD_LIBRARY_PATH=${PSYCHESTEERINGROOT}/${PSYCHESTEERINGCONFIG}/lib:${LD_LIBRARY_PATH}

RUN mkdir -p ${PSYCHEIOROOT}/${PSYCHEIOCONFIG}
COPY --from=psyche_build ${PSYCHEIOROOT}/inc ${PSYCHEIOROOT}/inc
COPY --from=psyche_build ${PSYCHEIOROOT}/${PSYCHEIOCONFIG}/lib ${PSYCHEIOROOT}/${PSYCHEIOCONFIG}/lib
ENV LD_LIBRARY_PATH=${PSYCHEIOROOT}/${PSYCHEIOCONFIG}/lib:${LD_LIBRARY_PATH}

RUN mkdir -p ${PSYCHESELECTIONSROOT}/${PSYCHESELECTIONSCONFIG}
COPY --from=psyche_build ${PSYCHESELECTIONSROOT}/inc ${PSYCHESELECTIONSROOT}/inc
COPY --from=psyche_build ${PSYCHESELECTIONSROOT}/parameters ${PSYCHESELECTIONSROOT}/parameters
COPY --from=psyche_build ${PSYCHESELECTIONSROOT}/${PSYCHESELECTIONSCONFIG}/lib ${PSYCHESELECTIONSROOT}/${PSYCHESELECTIONSCONFIG}/lib
ENV LD_LIBRARY_PATH=${PSYCHESELECTIONSROOT}/${PSYCHESELECTIONSCONFIG}/lib:${LD_LIBRARY_PATH}

RUN mkdir -p ${PSYCHECOREROOT}/${PSYCHECORECONFIG}
COPY --from=psyche_build ${PSYCHECOREROOT}/inc ${PSYCHECOREROOT}/inc
COPY --from=psyche_build ${PSYCHECOREROOT}/${PSYCHECORECONFIG}/lib ${PSYCHECOREROOT}/${PSYCHECORECONFIG}/lib
ENV LD_LIBRARY_PATH=${PSYCHECOREROOT}/${PSYCHECORECONFIG}/lib:${LD_LIBRARY_PATH}

ENV OAANALYSISREADER_VERSION=2.25

ENV OAANALYSISREADERROOT=${ND280_ROOT}/oaAnalysisReader_${OAANALYSISREADER_VERSION}
ENV OAANALYSISREADERCONFIG=${ND280_SYSTEM}
RUN mkdir -p ${OAANALYSISREADERROOT}/${OAANALYSISREADERCONFIG}
COPY --from=psyche_build ${OAANALYSISREADERROOT}/inc ${OAANALYSISREADERROOT}/inc
COPY --from=psyche_build ${OAANALYSISREADERROOT}/${OAANALYSISREADERCONFIG}/lib ${OAANALYSISREADERROOT}/${OAANALYSISREADERCONFIG}/lib
ENV LD_LIBRARY_PATH=${OAANALYSISREADERROOT}/${OAANALYSISREADERCONFIG}/lib:${LD_LIBRARY_PATH}

ENV ROOT_INCLUDE_PATH=${OAANALYSISREADERROOT}/inc/${ND280PROD}:${ROOT_INCLUDE_PATH}